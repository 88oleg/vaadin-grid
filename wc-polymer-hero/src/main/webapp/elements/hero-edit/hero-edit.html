<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-input/core-input.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../hero-sparkline/hero-sparkline.html">

<polymer-element name="hero-edit" attributes="heros current page">
  <template>
    <style>
      table {
        width: 40%;
        border: none;
        float: left;
      }
      .popup {
        width: 100%;
        position: absolute;
        height: 300px;
      }
      .map {
        width: 50%;
        height: 100%;
        position: absolute;
        left: 40%;
      }
    </style>
     <div id='epopup' class='popup' horizontal layout>
       <table id='eform'>
        <tr>
          <td colspan='2'><a on-tap='{{cancel}}' href='javascript:'>Cancel</a></td>
          <td width='10%'><button on-tap='{{save}}'>Save</button></td>
        </tr>
        <tr>
          <td rowspan='2' width='10%'><div class='picture'>Picture</div></td>
          <td><core-input value='{{hero.name}}'></core-input></td>
          <td>a.k.a.</td>
        </tr>
        <tr>
          <td colspan='2'><core-input value='{{hero.heroname}}'></core-input></td>
        </tr>
        <tr>
          <td>Vitals</td>
          <td colspan='2'>
            <div style='width: 20%'>
              <hero-sparkline color='#DF0016' height='12' width='90' points='{{hero.vitals.heart}}'></hero-sparkline>
              <div>Heart rate</div>
            </div>
            <div style='width: 20%'>Caffeine saturation</div>
            <div style='width: 20%'> {{caffeine * 10}} %</div>
            <div style='width: 20%'><button on-tap='{{inject}}'>Inject</button></div>
          </td>
        </tr>
        <tr>
          <td>Location</td>
          <td>{{hero.location.latitude}}</td>
          <td>{{hero.location.longitude}}</td>
        </tr>
        <tr>
          <td colspan='2'>IQ</td>
          <td><core-input value='{{hero.iq}}'></core-input></td>
        </tr>
        <tr>
          <td colspan='2'>Height</td>
          <td><core-input value='{{hero.height}}' placeholder='cm'></core-input></td>
        </tr>
        <tr>
          <td colspan='2'>Weight</td>
          <td><core-input value='{{hero.weight}}' placeholder='kg'></core-input></td>
        </tr>
        <tr>
          <td colspan='2'>Kill count</td>
          <td><core-input value='{{hero.killcount}}'></core-input></td>
        </tr>
        <tr>
          <td colspan='2'>Arch-enemy</td>
          <td>
            <select value='{{hero.archenemy}}' >
              <option template repeat="{{options}}">{{}}</option>
            </select>
          </td>
        </tr>
        <tr>
          <td colspan='3'>Mission stament
          <core-input multiline rows='4' value='{{hero.mission}}'></core-input></td>
        </tr>
        <tr>
          <td colspan='3'><button on-tap='{{terminate}}'>Terminate Hero</button></td>
        </tr>
       </table>
       <div id='emap' class='map'>
        <google-map id='gemap' zoom="10" fit>
          <google-map-marker id='gemark' title="{{hero.name}}" latitude="{{hero.location.latitude}}" longitude="{{hero.location.longitude}}"  draggable="true">{{hero.name}}</google-map-marker>
        </google-map>
       </div>
     </div>
  </template>
  <script>
    (function () {
      Polymer({
        ready: function() {
          this.options = ["a", "b"];
        },
        currentChanged: function() {
          this.hero = this.current >= 0 ? this.heros[this.current] : {};
        },
        pageChanged: function() {
          if (this.page == 2) {
            // This centers the map at the marker
            this.$.gemap.fitToMarkers = true;
            // This refreshes the view, otherwise only few map squares are displayed
            this.$.emap.removeChild(this.$.gemap);
            this.$.emap.appendChild(this.$.gemap);
            // This allows the user move the map
            this.$.gemap.fitToMarkers = false;

            // TODO: ask if caffeine percent is just the last value in the array
            var arr = this.hero.vitals.coffee;
            this.caffeine =  arr[arr.length - 1];
          }
        },
        herosChanged: function() {
          this.options = [];
          for (i in this.heros) {
            this.options.push(this.heros[i].heroname)
          }
        },
        cancel: function() {
          this.page = 1;
        },
        save: function() {
          for (k in this.hero) {
            this.heros[this.current][k] = this.hero[k];
          }
          this.page = -1;
        },
        remove: function() {
          this.heros.splice(this.current, 1);
          this.page = -1;
        },
        terminate: function() {
          // TODO: ask if terminated means remove or just change status
          this.heros[this.current].status = 'Terminated';
          this.page = -1;
        },
        inject: function() {
          var v = Math.min(10, this.caffeine + 1)
          var arr = this.hero.vitals.coffee;
          this.caffeine = arr[arr.length - 1] = v;
        }
      });
    })();
  </script>
</polymer-element>
