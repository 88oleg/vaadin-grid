<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../vaadin-x.html?abc">
<link rel="import" href="../hero-sparkline/hero-sparkline.html">

<script src="../../vaadin-x-utils.js"></script>
<polymer-element name="hero-list" attributes="hero heros current page">
  <template>
    <core-ajax
     auto = "true"
     url = "../../rest/list.json"
     handleAs ="json"
     method="POST"
     id='ajax'
     ></core-ajax>
    <div>Demo</div>
    <div>Superhero Roster</div>
    <div>{{size}} heroes on duty</div>
    <v-grid id='grid' theme='reindeer'>
    <table>
     <head>
      <thead>
        <tr>
          <th name='rank'>Rank</th>
          <th name='name'>Name</th>
          <th name='vitals'>Vitals</th>
          <th name='location'>Location</th>
          <th name='status'>Status</th>
        </tr>
      </thead>
     </head>
     </table>
    </v-grid>
  </template>
  <script>
    (function () {
      Polymer({
        ready: function() {
          var _this = this;
          this.size = 0;
          this.$.ajax.addEventListener('core-response', function(e) {
            waitUntilGridReady(_this.$.grid, function(grid) {
                _this.heros = e.detail.response.heros;
                _this.size = _this.heros.length;
                grid.rowCount = _this.size;
                grid.dataSource = _this.heros;
                grid.columns[3].renderer = function(element, data, rowIndex) {
                  element.innerHTML = (data.latitude + " " + data.longitude).replace(/(\d\.\d{4})\d+/g,"$1");
                };
                grid.columns[2].renderer = function(element, data, rowIndex) {
                  element.innerHTML = "<hero-sparkline colors='#DF0016,#3777DD' height='12' width='90' points='[[" +
                                         data.heart + "],[" + data.coffee + "]]' />";
                };

                _this.$.grid.shadowRoot.querySelector('table').addEventListener("click", function(e) {
                  // TODO: this could be a fix for selecing an item by clicking but does not work
                  // var input = e.target.parentElement.querySelector('td input');
                  // window.i = input;
                  // input.checked = true;
                  // var evt = document.createEvent("HTMLEvents");
                  // evt.initEvent("change", false, true);
                  // input.dispatchEvent(evt);
                });
            });
          });
          this.$.grid.addEventListener("select", function(e) {
            _this.current = _this.$.grid.selectedRow;
            if (_this.heros && _this.current >= 0) {
              _this.page = 1;
              _this.hero = _this.heros[_this.current];
            }
          });

        },
        pageChanged: function() {
          if (this.page == -1) {
            this.size = this.heros.length;
            this.$.grid.refresh();
          }
        },
      });
    })();
  </script>
</polymer-element>
