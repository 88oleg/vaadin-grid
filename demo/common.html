
<!-- Common imports for all examples -->
  <link rel="stylesheet" href="../../components-demo-resources/demo.css">
  <link rel="import" href="../../code-example/code-example.html">
  <link rel="import" href="../../table-of-contents/table-of-contents.html">
  <link rel="import" href="../../polymer/polymer.html">
  <link rel="import" href="../vaadin-grid.html">
  <script src="demodata.js"></script>
  <script src="../../vaadin-components/ga.js"></script>

  <!-- Common JS code for all examples -->
  <script>
    var randomUserUrl = 'https://randomuser.me/api/';

    window.xCodeExampleSourceHead =
    "  <script src='https://cdn.vaadin.com/vaadin-components/latest/webcomponentsjs/webcomponents-lite.js'><\/script>\n"+
    "  <link href='https://cdn.vaadin.com/vaadin-components/latest/vaadin-grid/vaadin-grid.html' rel='import'>\n"+
    "  <script>var randomUserUrl = '" + randomUserUrl + "';<\/script>\n";

    function createButton(text, fnc) {
      var button = document.createElement("button");
      button.innerHTML = text;
      button.addEventListener("click", fnc);
      return button;
    }

    // Faking randomuser.me REST call since the site is sometimes unavailable.
    // We have a set of 200 users cached in a static .json file instead, we
    // take it via ajax and split it conveniently based on parameters.
    XMLHttpRequest.prototype._open = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url, type) {
      // TODO: make angular2 http.get call work. It uses sync open and
      // seems not using onreadystatechange.
      if (type && url.startsWith(randomUserUrl)) {
        var tokens, re = /[?&]([^=]+)=([^&]*)/g;
        this.params = {};
        while (tokens = re.exec(url)) {
            this.params[tokens[1]] = tokens[2];
        }
        url = "users.json";
      }
      this._open(method, url, type)
    }
    XMLHttpRequest.prototype._send = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.send = function() {
      if (this.params) {
        this._onreadystatechange = this.onreadystatechange;
        this.onreadystatechange = function() {
          if (this.readyState == XMLHttpRequest.DONE  && this.status == 200) {
            this.text = this.responseText;
            var json = JSON.parse(this.text);
            // Since responseText is read only we need to redefine getters.
            var getter = {get: function(){return this.text;}};
            Object.defineProperty(this, "responseText" , getter);
            Object.defineProperty(this, "response" , getter);
            // Filter by gender
            if (this.params.gender) {
              json.results = json.results.filter(function (o) {
                return o.user.gender == this.params.gender;
              });
            }
            // limit results.
            if (this.params.results) {
              json.results = json.results.splice(0, this.params.results)
            }
            this.text = JSON.stringify(json)
          }
          // run original call after a while so as whe emulate slow connection.
          setTimeout(300, this._onreadystatechange());
          this.onreadystatechange = this._onreadystatechange;
        }
      }
      this._send();
    }
  </script>
