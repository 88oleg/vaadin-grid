<link rel='import' href='../../bower_components/polymer/polymer.html'>
<link rel='import' href="vaadin-grid-import.html">
<link rel="stylesheet" href="vaadin-grid.css" shim-shadowdom>

<dom-module id="v-grid">
  <template>
  </template>
</dom-module>


<script>
  var prototype = {
    is: "v-grid",

    mixins: [],

    published: {
      selectionMode: {
        reflect: true,
        type: String
      },

      disabled: {
        reflect: true,
        type: Boolean
      },

      editable: {
        reflect: true,
        type: Boolean
      },

      frozenColumn: {
        reflect: true,
        type: String
      }
    },

    bind: {
      selectionMode: 'setSelectionMode',
      dataSource: 'setDataSource',
      disabled: 'setDisabled',
      editable: 'setEditable',
      frozenColumn: 'setFrozenColumn',
      rows: 'setRowCount',
      rowCount: 'setRowCount',
    },

    attributeChanged: function(name, type, value) {
      switch (name) {
        case 'selected-rows':
          this.selectedRows = value.split(',').map(function(x) {
            return parseInt(x, 10);
          }).filter(function(x) {
            return !isNaN(x);
          });
          break;
        case 'selection-mode':
          this.selectionMode = value;
          break;
        case 'disabled':
          this.disabled = typeof value == "string";
          break;
        case 'editable':
          this.editable = typeof value == "string";
          break;
        case 'frozen-column':
          this.frozenColumn = value;
          break;
      }
    },

    listeners: {
      'select': 'onSelect'
    },

    onSelect: function() {
      this.setAttribute('selected-rows', this.selectedRows.join());
    },

    selectionModeChanged: function(mode) {
      this.setSelectionMode(mode);
    },

    ready: function() {
      this.setLightDom(this.lightDom.querySelector("table"));
      this.localDom.appendChild(this.getGridElement());
      this.initGrid();

      Object.defineProperty(this, 'scrollTop', {
        get: function() { return this.getScrollTop(); },
        set: function(newValue) { this.setScrollTop(newValue); },
        enumerable: true,
        configurable: false
      });
    },

    select: function(value) {
      var array = this.selectedRows;
      if (array.indexOf(value) == -1) {
        array.push(value);
        this.selectedRows = array;
      }
    },

    deselect: function(value) {
      var array = this.selectedRows;
      var index = array.indexOf(value);
      if (index > -1) {
        array.splice(index, 1);
        this.selectedRows = array;
      }
    },

    set selectedRows(r) {
      return this.setSelectedRows(r);
    },
    get selectedRows() {
      return this.getSelectedRows();
    },
    set columns(r) {
      this.setColumns(r);
    },
    get columns() {
      return this.getColumns();
    },
    get datasource() {
      return this.getDataSource();
    }
  };

  function loadComponent() {
    prototype.mixins.push(Object.getPrototypeOf(new vaadin.GridComponent()));
    VGrid = Polymer(prototype);
    // Give some time to gwt async processes to run (we need this in FF)
    setTimeout(function() {
      vaadin._v_grid_ready = true;
      document.dispatchEvent(new Event('v-grid-ready'));
    }, 5);
  }

  if (window.vaadin && window.vaadin.GridComponent) {
    loadComponent();
  } else {
    document.addEventListener("v-grid-loaded", function() {
      loadComponent();
    });
  }
</script>
