<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="../../../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../../bower_components/web-component-tester/browser.js"></script>
  <link rel="import" href="../vaadin-grid.html">
</head>
<body vaadin-theme='valo'>
<script>
function waitUntil(check, exec) {
  var id = setInterval(function() {
    if (check()) {
      clearInterval(id);
      exec();
    }
  }, 100);
}
function waitUntilGridReady(grid, exec) {
  waitUntil(function() {
    return grid && grid.dataSource && grid;
  }, exec);
}
</script>

<script>
suite('vaadin-grid', function() {
  var grid;

  setup(function(done) {
    if (grid && grid.parentElement) {
      grid.parentElement.removeChild(grid);
    }
    grid = document.createElement('v-grid');

    grid.innerHTML = "<table><thead><tr><th>Name</th><th>Value</th></tr></thead>"+
    "<tbody><tr><td>Grid</td><td>10000</td></tr></tbody></table>";

    document.body.appendChild(grid);
    waitUntilGridReady(grid, done);
  });

  test('light dom table header gets rendered in the grid', function() {
    var row = grid.querySelector(".v-grid-header .v-grid-row");
    var cells = row.childNodes;

    assert.isTrue(cells[0].innerHTML == 'Name');
    assert.isTrue(cells[1].innerHTML == 'Value');
  });

  test('light dom table body gets rendered in the grid', function() {
    var row = grid.querySelector(".v-grid-body .v-grid-row");
    var cells = row.childNodes;

    assert.isTrue(cells[0].innerHTML == 'Grid');
    assert.isTrue(cells[1].innerHTML == '10000');
  });

  test('changes to the light dom cells get reflected to composed dom', function(done) {
    var tableHeaderCell = grid.querySelector("thead th");
    tableHeaderCell.innerHTML = "TestH";

    var tableBodyCell = grid.querySelector("tbody td");
    tableBodyCell.innerHTML = "TestB";

    waitUntilGridReady(grid, function() {
      var gridHeaderCell = grid.querySelector(".v-grid-header .v-grid-cell");
      assert.isTrue(gridHeaderCell.innerHTML == 'TestH');
      var gridBodyCell = grid.querySelector(".v-grid-body .v-grid-cell");
      assert.isTrue(gridBodyCell.innerHTML == 'TestB');
      done();
    });
  });

  test('row declarative select', function() {
    grid.setAttribute("selectedrow", "0");
    assert.ok(grid.querySelector(".v-grid-body .v-grid-row-selected"));
    grid.removeAttribute("selectedrow");
    assert.notOk(grid.querySelector(".v-grid-body .v-grid-row-selected"));
  });

  test('row click select', function() {
    grid.querySelector(".v-grid-body .v-grid-cell").click();
    assert.equal(grid.getAttribute("selectedrow"), "0");
    grid.querySelector(".v-grid-body .v-grid-cell").click();
    assert.notOk(grid.getAttribute("selectedrow"));
  });

  test('add new row to the light dom', function(done) {
    var tBodyRow = document.createElement("tr");
    tBodyRow.innerHTML = "<td>Test</td><td>99</td>";

    var tBody = grid.querySelector("table tbody");
    tBody.appendChild(tBodyRow);

    waitUntilGridReady(grid, function() {
      var rows = grid.querySelector(".v-grid-body").childNodes;
      var cells = rows[rows.length - 1].childNodes;

      assert.isTrue(cells[0].innerHTML == 'Test');
      assert.isTrue(cells[1].innerHTML == '99');
      done();
    });
  });
});
</script>

</body>
</html>
